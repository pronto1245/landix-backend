class HamsterRunGame {
  constructor() {
    ((this.game = document.getElementById('game')),
      (this.spinButton = document.getElementById('go-btn')),
      (this.gameArrowsContainer = document.getElementById('game-field-arrows')),
      (this.gameStatsContainer = document.getElementById('game-stats-win-list')),
      (this.statsBalance = document.getElementById('game-stats-balance')),
      (this.statsWinBalance = document.getElementById('game-stats-win-balance')),
      (this.controlsBalance = document.getElementById('game-controls-balance')),
      (this.modal = document.getElementById('modal')),
      (this.winButton = document.getElementById('win-button-modal')),
      (this.modalBalance = document.getElementById('modal-balance')),
      (this.effectsContainer = document.getElementById('effects')),
      (this.effectsImage = document.getElementById('effects-image')),
      (this.progressTop = document.getElementById('game-progress-top')),
      (this.progressBottom = document.getElementById('game-progress-bottom')),
      (this.multipliersContainer = document.getElementById('game-multipliers')),
      (this.rate = this.game.dataset.rate),
      (this.currency = this.game.dataset.currency),
      (this.multipliers = [3, 10, 0.2, 50]),
      (this.maxSteps = 4),
      (this.currentStep = 0),
      (this.currentBalance = 0),
      (this.winSound = new Audio(
        '/assets/general/sound/playful-casino-slot-machine-jackpot-3-183921.mp3'
      )),
      (this.spinSound = new Audio('/assets/general/sound/arrow-spin.webm')),
      (this.clickSound = new Audio('/assets/general/sound/arrow-click.webm')));
  }
  initGame() {
    (this.calculateFontSize(this.spinButton),
      this.calculateButtonScale(this.winButton),
      window.addEventListener('placementOpenModal', () => this.showModal()),
      this.spinButton.addEventListener('click', () => this.initSpin()));
  }
  initSpin() {
    window.isMobile && window.pushPlacement && !window.firstClick
      ? window.dispatchEvent(
          new CustomEvent('placementFirstClick', { detail: [this.spin.bind(this)] })
        )
      : this.spin();
  }
  setWin() {
    document.body.classList.add('is--win');
  }
  setDisabled() {
    (document.body.classList.add('is--disabled'),
      this.currentStep < this.maxSteps &&
        setTimeout(() => {
          document.body.classList.remove('is--disabled');
        }, 500));
  }
  async spin() {
    (this.playSound(this.clickSound, 0, 0.2),
      this.currentStep < this.maxSteps &&
        ((this.currentStep += 1),
        this.setDisabled(),
        this.showArrow(),
        this.updateBalance(),
        setTimeout(() => {
          this.playSound(this.spinSound, 0, 0.5);
        }, 100)),
      this.currentStep >= this.maxSteps &&
        setTimeout(() => {
          (this.setWin(),
            this.showEffects(),
            this.playSound(this.winSound),
            this.triggerShowModal());
        }, 1500));
  }
  showArrow() {
    const e = document.createElement('div');
    e.className = `game-field__arrows-item is--${this.currentStep}`;
    const t = document.createElement('span');
    t.className = 'game-field__arrows-item-arrow';
    const s = document.createElement('span');
    s.className = 'game-field__arrows-item-hole';
    const n = document.createElement('span');
    ((n.className = 'game-field__arrows-item-multiplier'),
      (n.textContent = `+${this.multipliers[this.currentStep - 1] * this.rate}${this.currency}`),
      e.appendChild(t),
      e.appendChild(s),
      e.appendChild(n),
      this.gameArrowsContainer.appendChild(e));
  }
  updateBalance() {
    const e = Number(this.multipliers[this.currentStep - 1]),
      t = Number(this.rate) * e,
      s = document.createElement('li');
    s.className = 'game-stats__list-item';
    const n = document.createElement('img');
    ((n.src = `assets/forestFortune4/img/arrow-icon-${this.currentStep}.webp`), (n.alt = ''));
    const a = document.createElement('span');
    a.className = 'game-stats__list-item-value';
    const i = document.createElement('span');
    i.textContent = `${t}`;
    const o = document.createElement('span');
    ((o.className = 'game-stats__list-item-value-symbol'),
      (o.textContent = this.currency),
      a.appendChild(i),
      a.appendChild(o),
      s.appendChild(n),
      s.appendChild(a),
      (this.currentBalance += t));
    const l = this.currentBalance;
    setTimeout(() => {
      [this.statsBalance, this.controlsBalance, this.modalBalance, this.statsWinBalance].forEach(
        (e) => {
          (this.gameStatsContainer.prepend(s), (e.innerText = Number(l.toFixed(2))));
        }
      );
    }, 500);
  }
  triggerShowModal(e = 0) {
    setTimeout(() => {
      window.dispatchEvent(new Event('placementOpenModal'));
    }, e);
  }
  showModal() {
    (document.body.classList.add('is--modal-open'), this.modal.classList.add('is--active'));
  }
  showEffects(e = 0, t = 1500) {
    (this.effectsContainer.classList.add('visible'),
      setTimeout(() => {
        const e = document.createElement('div');
        ((e.style.backgroundImage = `url(${this.effectsImage.src})`),
          e.classList.add('effects__block'),
          this.effectsContainer.appendChild(e),
          setTimeout(() => {
            (this.effectsContainer.classList.remove('visible'),
              this.effectsContainer.classList.add('hidden'));
          }, t));
      }, e));
  }
  playSound(e, t = 0, s = 1) {
    setTimeout(() => {
      ((e.muted = !1),
        (e.currentTime = 0),
        (e.volume = s),
        e.play().catch((e) => {
          console.error('РџРѕРјРёР»РєР° РїСЂРё РІС–РґС‚РІРѕСЂРµРЅРЅС– Р°СѓРґС–Рѕ: ', e);
        }));
    }, t);
  }
  calculateButtonScale(e, t = { min: 0.5, max: 1, step: 0.07 }) {
    if (!e) return;
    const s = window.getComputedStyle(e, '::before'),
      n = s.getPropertyValue('width'),
      a = s.getPropertyValue('left'),
      i = parseFloat(n),
      o = parseFloat(a),
      l = isNaN(i) ? 0 : i,
      c = isNaN(o) ? 0 : o,
      r = e.getBoundingClientRect().width + (l - c),
      m = window.innerWidth;
    if (r <= m) return void (e.style.transform = `scale(${t.max})`);
    const d = r / m,
      h = Math.max(t.max - (d - 1) * t.step * 10, t.min),
      u = e.querySelectorAll('span');
    (u &&
      u.forEach((e) => {
        e.style.whiteSpace = 'nowrap';
      }),
      (e.parentElement.style.transform = `scale(${h})`),
      (e.parentElement.style.transformOrigin = 'center'));
  }
  calculateFontSize(e, t = { threshold: 5, step: 0.03, minPercent: 0.6 }) {
    if (!e) return;
    const s = e.querySelectorAll('span');
    s &&
      s.forEach((e) => {
        const s = String(e.innerText).length,
          n = window.getComputedStyle(e),
          a = parseFloat(n.getPropertyValue('font-size')),
          i = a,
          o = a * t.minPercent,
          l = Math.max(0, s - t.threshold),
          c = Math.max(i - l * (a * t.step), o);
        e.style.fontSize = `${c}px`;
      });
  }
}
document.addEventListener('DOMContentLoaded', () => {
  new HamsterRunGame().initGame();
});
