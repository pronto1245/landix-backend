class MinesGame {
  constructor() {
    ((this.game = document.getElementById('game')),
      (this.balance = document.getElementById('game-balance')),
      (this.wallet = document.getElementById('game-wallet')),
      (this.progress = document.getElementById('game-progress')),
      (this.multiplier = document.getElementById('game-multiplier')),
      (this.sectors = document.querySelectorAll('.game-field__item')),
      (this.cashButton = document.getElementById('game-cash-btn')),
      (this.randomBtn = document.getElementById('game-random-btn')),
      (this.readyButton = document.getElementById('go-btn')),
      (this.winButton = document.getElementById('win-button-modal')),
      (this.modal = document.getElementById('modal')),
      (this.modalBalance = document.getElementById('modal-balance')),
      (this.effectsContainer = document.getElementById('effects')),
      (this.effectsImage = document.getElementById('effects-image')),
      (this.winSound = new Audio('/assets/general/sound/mines-win.mp3')),
      (this.winSectorSound = new Audio('/assets/general/sound/mines-sector-win.mp3')),
      (this.randomClickSound = new Audio('/assets/general/sound/mines-random-click.mp3')),
      (this.readyclickSound = new Audio('/assets/general/sound/mines-ready-click.mp3')),
      (this.rate = this.game.dataset.rate),
      (this.multipliers = this.game.dataset.multipliers),
      (this.maxMines = 6),
      (this.maxSpins = 7),
      (this.currentSpin = 0));
  }
  initGame() {
    ([this.readyButton, this.winButton, this.cashButton].forEach((t) => {
      this.calculateFontSize(t);
    }),
      window.addEventListener('placementOpenModal', () => this.showModal()),
      this.readyButton.addEventListener('click', () => this.initReady()),
      this.cashButton.addEventListener('click', () => this.setWin()));
  }
  initReady() {
    window.isMobile && window.pushPlacement && !window.firstClick
      ? window.dispatchEvent(
          new CustomEvent('placementFirstClick', {
            detail: [this.setReady.bind(this)]
          })
        )
      : this.setReady();
  }
  setReady() {
    (this.playSound(this.readyclickSound),
      this.game.classList.add('is--ready'),
      (this.wallet.innerText = '0'),
      this.sectors.forEach((t) => {
        t.addEventListener('click', () => this.spin(t));
      }),
      this.randomBtn.addEventListener('click', () => {
        this.playSound(this.randomClickSound);
        const t = this.getRandomSector();
        this.spin(t);
      }));
  }
  setStarted() {
    this.game.classList.add('is--started');
  }
  setWin() {
    (this.game.classList.add('is--win'),
      this.showAllSectors(),
      this.playSound(this.winSound, 1e3),
      this.showEffects(1e3),
      this.triggerShowModal(1e3));
  }
  getRandomSector() {
    const t = this.getAvailableSectors();
    return t[Math.floor(Math.random() * t.length)];
  }
  getAvailableSectors() {
    const t = [];
    return (
      this.sectors.forEach((e) => {
        e.classList.contains('is--active') || t.push(e);
      }),
      t
    );
  }
  spin(t) {
    (this.currentSpin < this.maxSpins &&
      ((this.currentSpin += 1),
      this.showSector(t, 'is--win'),
      this.playSound(this.winSectorSound),
      this.updateBalance(),
      this.updateProgress(),
      this.updateMultiplier()),
      this.currentSpin >= 0 && this.setStarted(),
      this.currentSpin >= this.maxSpins && this.setWin());
  }
  showSector(t, e = 'is--default') {
    t.classList.contains('is--active') || t.classList.add('is--active', e);
  }
  showAllSectors() {
    const t = this.getAvailableSectors(),
      e = Math.max(0, this.maxSpins - this.currentSpin),
      s = new Set();
    for (; s.size < this.maxMines + e; ) s.add(Math.floor(Math.random() * t.length));
    const i = [...s],
      n = i.slice(0, e),
      a = i.slice(e);
    t.forEach((t, e) => {
      this.showSector(t, n.includes(e) ? 'is--win' : a.includes(e) ? 'is--lose' : 'is--default');
    });
  }
  updateProgress() {
    this.progress.style.width = (this.currentSpin / this.maxSpins) * 100 + '%';
  }
  updateBalance() {
    if (this.currentSpin <= this.maxSpins) {
      const t = this.multipliers.split(','),
        e = this.rate * t[this.currentSpin - 1];
      ((this.balance.innerText = e), (this.modalBalance.innerText = e));
    }
  }
  updateMultiplier() {
    if (this.currentSpin <= this.maxSpins - 1) {
      const t = this.multipliers.split(',');
      this.multiplier.innerText = t[this.currentSpin];
    }
  }
  showEffects(t = 0, e = 1500) {
    (this.effectsContainer.classList.add('visible'),
      setTimeout(() => {
        const t = document.createElement('div');
        ((t.style.backgroundImage = `url(${this.effectsImage.src})`),
          t.classList.add('effects__block'),
          this.effectsContainer.appendChild(t),
          setTimeout(() => {
            (this.effectsContainer.classList.remove('visible'),
              this.effectsContainer.classList.add('hidden'));
          }, e));
      }, t));
  }
  showModal() {
    (document.body.classList.add('is--modal-open'), this.modal.classList.add('is--active'));
  }
  playSound(t, e = 0) {
    setTimeout(() => {
      ((t.muted = !1),
        (t.currentTime = 0),
        t.play().catch((t) => {
          console.error('Помилка при відтворенні аудіо: ', t);
        }));
    }, e);
  }
  triggerShowModal(t = 0) {
    setTimeout(() => {
      window.dispatchEvent(new Event('placementOpenModal'));
    }, t);
  }
  calculateFontSize(
    t,
    e = {
      threshold: 10,
      step: 0.03,
      minPercent: 0.5
    }
  ) {
    if (!t) return;
    const s = t.querySelectorAll('span');
    s &&
      s.forEach((t) => {
        const s = String(t.innerText).length,
          i = window.getComputedStyle(t),
          n = parseFloat(i.getPropertyValue('font-size')),
          a = n,
          o = n * e.minPercent,
          d = Math.max(0, s - e.threshold),
          c = Math.max(a - d * (n * e.step), o);
        t.style.fontSize = `${c}px`;
      });
  }
}
document.addEventListener('DOMContentLoaded', () => {
  new MinesGame().initGame();
});
