class ChickenRoadGame {
  constructor() {
    ((this.game = document.getElementById('game')),
      (this.char = document.getElementById('game-char')),
      (this.field = document.getElementById('game-field')),
      (this.sectors = document.querySelectorAll('.game__sector')),
      (this.spinButton = document.getElementById('go-btn')),
      (this.cashButton = document.getElementById('cash-btn')),
      (this.winButton = document.getElementById('win-button-modal')),
      (this.modal = document.getElementById('modal')),
      (this.controls = document.getElementById('game-controls')),
      (this.balance = document.getElementById('balance')),
      (this.modalBalance = document.getElementById('modal-balance')),
      (this.modalMultiplier = document.getElementById('modal-multiplier')),
      (this.effectsContainer = document.getElementById('effects')),
      (this.effectsImage = document.getElementById('effects-image')),
      (this.spinSound = new Audio(
        'https://landix.group/asset/general/sound/chicken-road-button-click.mp3'
      )),
      (this.winSound = new Audio(
        'https://landix.group/asset/general/sound/chicken-road-button-win.mp3'
      )),
      (this.rate = document.getElementById('rate').dataset.rate),
      (this.multipliers = document.getElementById('rate').dataset.multipliers),
      (this.sectorWidth = this.sectors[0].offsetWidth),
      (this.charMoves = 0),
      (this.currentStep = 0),
      (this.firstStepIndex = 1),
      (this.lastStepIndex = 7),
      (this.stepTime = 700),
      (this.spaceScrolled = window.innerWidth),
      (this.isDesktop = window.innerWidth > 768));
  }
  initGame() {
    (this.showNextSector(this.currentStep),
      this.calculateFontSize(this.spinButton),
      this.calculateFontSize(this.cashButton),
      this.calculateFontSize(this.winButton, { threshold: 30, step: 0.02, minPercent: 0.6 }),
      window.addEventListener('placementOpenModal', () => {
        this.showModal();
      }),
      this.spinButton.addEventListener('click', () => {
        this.initSpin();
      }),
      this.cashButton.addEventListener('click', () => {
        (this.showEffects(),
          this.triggerShowModal(),
          this.playSound(this.winSound),
          this.disableControls(1e4));
      }));
  }
  initSpin() {
    window.isMobile && window.pushPlacement && !window.firstClick && 0 === this.currentStep
      ? window.dispatchEvent(
          new CustomEvent('placementFirstClick', { detail: [this.spin.bind(this)] })
        )
      : this.spin();
  }
  spin() {
    ((this.currentStep += 1),
      this.isDesktop &&
        (this.currentStep === this.firstStepIndex ||
          this.currentStep === this.lastStepIndex ||
          this.spaceScrolled > this.field.offsetWidth) &&
        (this.charMoves += 1),
      this.moveChar(this.currentStep),
      this.moveField(this.currentStep),
      this.playSound(this.spinSound),
      this.disableControls(this.stepTime),
      setTimeout(() => {
        (this.showNextSector(this.currentStep),
          this.showActiveSector(this.currentStep),
          this.showActiveSector(this.currentStep),
          this.showFinishedSector(this.currentStep),
          this.updateBalance(this.currentStep),
          this.updateMultiplier(this.currentStep));
      }, this.stepTime / 2),
      this.currentStep === this.firstStepIndex && this.setControlPanelActivated(),
      this.currentStep === this.lastStepIndex &&
        (this.showEffects(1e3),
        this.playSound(this.winSound, 1e3),
        this.triggerShowModal(1e3),
        this.disableControls(1e4)));
  }
  calculateFontSize(t, e = { threshold: 25, step: 0.02, minPercent: 0.6 }) {
    if (!t) return;
    const s = t.querySelectorAll('span');
    s &&
      s.forEach((t) => {
        const s = String(t.innerText).length,
          i = window.getComputedStyle(t),
          n = parseFloat(i.getPropertyValue('font-size')),
          o = n,
          a = n * e.minPercent,
          h = Math.max(0, s - e.threshold),
          c = Math.max(o - h * (n * e.step), a);
        t.style.fontSize = `${c}px`;
      });
  }
  showNextSector(t) {
    const e = this.sectors[t];
    e && e.classList.add('is--next');
  }
  showActiveSector(t) {
    const e = this.sectors[t - 1];
    e && (e.classList.add('is--active'), e.classList.remove('is--next'));
  }
  showFinishedSector(t) {
    const e = this.sectors[t - 2];
    e &&
      (e.classList.add('is--finished'),
      e.classList.remove('is--next'),
      e.classList.remove('is--active'));
  }
  moveField(t) {
    const e = this.sectorWidth * (t - this.charMoves);
    ((this.field.style.transform = `translateX(-${e}px)`), (this.spaceScrolled += e));
  }
  moveChar(t) {
    if (
      (this.char.classList.add('is--active'),
      this.isDesktop && (1 === t || 7 === t || this.spaceScrolled > this.field.offsetWidth))
    ) {
      const t = this.sectorWidth * this.charMoves;
      this.char.style.transform = `translateX(${t}px)`;
    }
    setTimeout(() => {
      this.char.classList.remove('is--active');
    }, this.stepTime);
  }
  setControlPanelActivated() {
    this.controls.classList.add('is--active');
  }
  updateBalance(t) {
    const e = this.multipliers.split(','),
      s = this.rate * e[t - 1];
    ((this.balance.innerText = s), (this.modalBalance.innerText = s));
  }
  updateMultiplier(t) {
    const e = this.multipliers.split(',');
    this.modalMultiplier.innerText = e[t - 1];
  }
  disableControls(t) {
    (this.spinButton.setAttribute('disabled', ''),
      t &&
        setTimeout(() => {
          this.spinButton.removeAttribute('disabled');
        }, t));
  }
  showEffects(t = 0, e = 1500) {
    (this.effectsContainer.classList.add('visible'),
      setTimeout(() => {
        const t = document.createElement('div');
        ((t.style.backgroundImage = `url(${this.effectsImage.src})`),
          t.classList.add('effects__block'),
          this.effectsContainer.appendChild(t),
          setTimeout(() => {
            (this.effectsContainer.classList.remove('visible'),
              this.effectsContainer.classList.add('hidden'));
          }, e));
      }, t));
  }
  showModal() {
    (document.body.classList.add('is--modal-open'), this.modal.classList.add('is--active'));
  }
  playSound(t, e = 0) {
    setTimeout(() => {
      ((t.muted = !1),
        (t.currentTime = 0),
        t.play().catch((t) => {
          console.error('РџРѕРјРёР»РєР° РїСЂРё РІС–РґС‚РІРѕСЂРµРЅРЅС– Р°СѓРґС–Рѕ: ', t);
        }));
    }, e);
  }
  triggerShowModal(t = 0) {
    setTimeout(() => {
      window.dispatchEvent(new Event('placementOpenModal'));
    }, t);
  }
}
document.addEventListener('DOMContentLoaded', () => {
  new ChickenRoadGame().initGame();
});
